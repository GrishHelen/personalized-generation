# personalized-generation
## Курсовой проект по теме "Исследование методов персонализированной генерации с помощью диффузионных моделей", 3 курс (2024-25)

### Аннотация

Персонализированная генерация изображений — активно развивающееся направление в области компьютерного зрения, позволяющее создавать консистентные визуальные представления объектов в разнообразных сценах на основе текстовых описаний или референсных фотографий. Однако существующие методы сталкиваются с рядом ограничений: высокой вычислительной сложностью, снижением качества при работе со специфичными доменами и недостаточной гибкостью в адаптации к пользовательским запросам.

В данной работе было предложено избавиться от маскирования и использовать сингулярное разложение матриц механизма внимания для контроля над консистентностью объекта при генерации в различных сценах. Для нивелирования проблемы протекания фона было предложено несколько стратегий зануления младших сингулярных чисел. Также были реализованы и исследованы различные техники перевзвешивания сингулярных чисел для повышения визуального сходства объекта внутри батча. 

### Воспроизведение основных бейзлайнов

В качестве основного бейзлайна в данной работе рассматривается метод [Consistory](https://github.com/NVlabs/consistory.git). 

#### Примеры работы ConsiStory
В ходе проведенного исследования были проанализированы результаты бейзлайна. В частности, было отобрано 10 примеров успешной работы метода ConsiStory, демонстрирующих высокую степень согласованности внешнего вида объекта в различных сценах. Также были выявлены 10 случаев, в которых ConsiStory показал недостаточное качество. В этих примерах наблюдаются значительные расхождения во внешнем виде объекта на сгенерированных изображениях. Примеры хорошей и плохой работы редота представлены на рисунке ниже.

![Coursework_3year(кт-1)_page-0008](https://github.com/user-attachments/assets/3a570262-4721-4a21-a06f-b90b37a6d170)

Эксперименты показали, что метод как правило демонстрирует высокое качество при генерации изображений с животными (например, если объектом являются леопард или дельфин), сохраняя консистентность их визуальных особенностей между изображениями в различных сценах. Однако для неодушевленных объектов (автобус, коробка) зачастую наблюдается снижение стабильности: их внешний вид варьируется в зависимости от контекста.

#### Анализ недостатков бейзлайна и возможных улучшений метода

Одним из ключевых недостатков ConsiStory является зависимость его ключевого компонента (SDSA) от точности локализации объекта в изображении. В случае нетипичных объектов это может приводить к усилению расхождений во внешнем виде объектов. В данной работе предполагается преодолеть эту проблему и усовершенствовать метод, предложив другой способ модифицировать стандартный self-attention для повышения консистентности объекта на различных изображениях.


### Гипотезы

1. Основная гипотеза состоит в том, что старшие сингулярные числа матриц $K$ и $V$ в self-attention несут информацию о самых значимых частях соответствующих изображений и, в частности, об объектах на них. Тогда зануление младших сингулярных чисел для `якорных' (референсных) изображений в процессе применения механизма внимания может снизить протекание фона, но не уменьшит консистентность ключевых объектов.

2. Увеличение старших сингулярных чисел поможет сохранить концепт на изображениях ярче. В результате этого может увеличиться похожесть объектов между изображениями.

### Результаты

В данной работе было проведено исследование о влиянии изменения сингулярных чисел матриц ключей $K$ и значений $V$ в механизме внимания на качество генерации и консистентность объекта в различных сценах. Проведенные эксперименты подтвердили справедливость первой гипотезы, доказав, что главные компоненты содержат основную информации о концепте, а частичное зануление младших сингулярных чисел в процессе применения модифицированного self-attention позволяет снизить протекание фона при отсутствии маскирования объектов. Тестирование различных стратегий сохранения сингулярных чисел показало превосходство квантильного подхода для зануляения сингулярных чисел (с сохранением фиксированной доли сингулярных чисел) и энергетического критерия (на основе вклада сингулярных чисел в кумулятивную энергию).

Также было установлено, что матрица $K$ преимущественно определяет фоновые детали, а матрица $V$ больше влияет на сходство объектов. 

Первоначальное предположение о том, что увеличение скорости затухания сингулярных чисел будет способствовать усилению концепта и увеличению визуального сходства объекта между изображениями батча, не подтвердилось. Напротив, сглаживание спектра матриц путем логарифмического преобразования позволило повысить конситентность. Полученные результаты показывают, что предложенный метод логарифмического перевзвешивания сингулярных чисел, несмотря на существующие ограничения, демонстрирует значительное улучшение в сравнении с бейзлайном и может рассматриваться как перспективное направление для дальнейших исследований. На иллюстрации ниже показано сравнение методов, показывающее, что применение данной методики привело к заметному повышению визуального сходства генерируемых объектов, а протекание фона незначительно либо не критично.

![Текст отчета_page-0017](https://github.com/user-attachments/assets/ecf37a4b-2761-4f5d-bf3c-b8324672b106)

